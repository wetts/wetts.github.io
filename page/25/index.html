<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wetts.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Stay Hungry, Stay Foolish. [build by hexo&#x2F;next&#x2F;gitalk&#x2F;hexo-generator-search&#x2F;LaTeX]">
<meta property="og:type" content="website">
<meta property="og:title" content="Wetts&#39;s blog">
<meta property="og:url" content="https://wetts.github.io/page/25/index.html">
<meta property="og:site_name" content="Wetts&#39;s blog">
<meta property="og:description" content="Stay Hungry, Stay Foolish. [build by hexo&#x2F;next&#x2F;gitalk&#x2F;hexo-generator-search&#x2F;LaTeX]">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zhang Wetts">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wetts.github.io/page/25/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Wetts's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Wetts's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Stay Hungry, Stay Foolish.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/wetts" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2017/01/03/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-references/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/03/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-references/" class="post-title-link" itemprop="url">MongoDB-references</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-03 22:25:44" itemprop="dateCreated datePublished" datetime="2017-01-03T22:25:44+08:00">2017-01-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转自：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/database-references/">https://docs.mongodb.com/manual/reference/database-references/</a></p>
<p>MongoDB does not support joins. In MongoDB some data is denormalized, or stored with related data in documents to remove the need for joins. However, in some cases it makes sense to store related information in separate documents, typically in different collections or databases.</p>
<p>MongoDB applications use one of two methods for relating documents:</p>
<ul>
<li>Manual references where you save the <code>_id</code> field of one document in another document as a reference. Then your application can run a second query to return the related data. These references are simple and sufficient for most use cases.</li>
<li>DBRefs are references from one document to another using the value of the first document’s <code>_id</code> field, collection name, and, optionally, its database name. By including these names,  <strong>DBRefs allow documents located in multiple collections to be more easily linked with documents from a single collection.</strong></li>
</ul>
<p>To resolve DBRefs, your application must perform additional queries to return the referenced documents. Many drivers have helper methods that form the query for the DBRef automatically. The drivers do not automatically resolve DBRefs into documents.</p>
<p>DBRefs provide a common format and type to represent relationships among documents. The DBRef format also provides common semantics for representing links between documents if your database must interact with multiple frameworks and tools.</p>
<p>Unless you have a compelling reason to use DBRefs, use manual references instead.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2017/01/03/%E5%B7%A5%E7%A8%8B/%E6%8E%A5%E5%8F%A3/%E6%8E%A5%E5%8F%A3%E5%88%97%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/03/%E5%B7%A5%E7%A8%8B/%E6%8E%A5%E5%8F%A3/%E6%8E%A5%E5%8F%A3%E5%88%97%E8%A1%A8/" class="post-title-link" itemprop="url">接口列表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-03 22:05:57" itemprop="dateCreated datePublished" datetime="2017-01-03T22:05:57+08:00">2017-01-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8E%A5%E5%8F%A3/" itemprop="url" rel="index"><span itemprop="name">接口</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="天气接口"><a href="#天气接口" class="headerlink" title="天气接口"></a>天气接口</h3><ul>
<li><code>http://wthrcdn.etouch.cn/weather_mini?citykey=101010100</code></li>
<li><code>http://wthrcdn.etouch.cn/weather_mini?city=北京</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2017/01/01/%E7%B3%BB%E7%BB%9F&%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx-HTTP%E7%8A%B6%E6%80%81%E7%A0%81-499/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/01/%E7%B3%BB%E7%BB%9F&%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx-HTTP%E7%8A%B6%E6%80%81%E7%A0%81-499/" class="post-title-link" itemprop="url">Nginx-HTTP状态码-499</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-01 08:54:17" itemprop="dateCreated datePublished" datetime="2017-01-01T08:54:17+08:00">2017-01-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">服务器</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转自：<a target="_blank" rel="noopener" href="http://www.lc365.net/blog/b/23997/">http://www.lc365.net/blog/b/23997/</a></p>
<p>日志记录中HTTP状态码出现499错误有多种情况，我遇到的一种情况是nginx反代到一个永远打不开的后端，就这样了，日志状态记录是499、发送字节数是0。</p>
<p>499错误是什么？让我们看看NGINX的源码中的定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ngx_string(ngx_http_error_495_page), /* 495, https certificate error */</span><br><span class="line">ngx_string(ngx_http_error_496_page), /* 496, https no certificate */</span><br><span class="line">ngx_string(ngx_http_error_497_page), /* 497, http to https */</span><br><span class="line">ngx_string(ngx_http_error_404_page), /* 498, canceled */</span><br><span class="line">ngx_null_string,                    /* 499, client has closed connection */</span><br></pre></td></tr></table></figure>
<p>可以看到，499对应的是 “client has closed connection”。这很有可能是因为服务器端处理的时间过长，客户端“不耐烦”了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-$where%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-$where%E6%9F%A5%E8%AF%A2/" class="post-title-link" itemprop="url">MongoDB-常用命令-$where查询</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-31 13:57:22" itemprop="dateCreated datePublished" datetime="2016-12-31T13:57:22+08:00">2016-12-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转自：<a target="_blank" rel="noopener" href="http://blog.163.com/wm_at163/blog/static/132173490201252610424458/">http://blog.163.com/wm_at163/blog/static/132173490201252610424458/</a></p>
<p>有时候，键值对的查询方式并不能满足我们的需求，我们有如下一个集合：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; “_id” : ObjectId(“4e9165cf717ed94f8289ac0c”), “bar” : “baz”, “count” : 35 &#125;</span><br><span class="line">&#123; “_id” : ObjectId(“4e916661739f1da5452a4dfe”), “bar” : “bazz”, “count” : 3 &#125;</span><br><span class="line">&#123; “_id” : ObjectId(“4e9165cf717ed94f8289ac0d”), “bar” : “baz”, “count” : 35 &#125;</span><br><span class="line">&#123; “_id” : ObjectId(“4e928bf8735a86e2c6f848ed”), “apple” : 1, “banana” : 6, “peach” : 3 &#125;</span><br><span class="line">&#123; “_id” : ObjectId(“4e928c17735a86e2c6f848ee”), “apple” : 1, “spinach” : 4, “watermelon” : 4 &#125;</span><br><span class="line">&#123; “_id” : ObjectId(“4e928d8a735a86e2c6f848ef”), “bar” : “baz”, “banana” : “baz” &#125;</span><br></pre></td></tr></table></figure>
<p>需要返回有两个字段相同的文档，也就是要返回如下文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; “_id” : ObjectId(“4e928c17735a86e2c6f848ee”), “apple” : 1, “spinach” : 4, “watermelon” : 4 &#125;</span><br><span class="line">&#123; “_id” : ObjectId(“4e928d8a735a86e2c6f848ef”), “bar” : “baz”, “banana” : “baz” &#125;</span><br></pre></td></tr></table></figure>
<p>就需要使用”$where“并借助javascript来做了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find(&#123;“$where”:function()&#123;</span><br><span class="line">… for(var current in this)&#123;</span><br><span class="line">…   for(var other in this)&#123;</span><br><span class="line">…     if(current != other &amp;&amp; this[current] == this[other])&#123;</span><br><span class="line">…       return true;</span><br><span class="line">…     &#125;</span><br><span class="line">…   &#125;</span><br><span class="line">… &#125;</span><br><span class="line">… return false;</span><br><span class="line">… &#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>如果返回true，文档作为结果的一部分被返回；如果为false，则不会返回。</p>
<p>$where查询有以下几种写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find(&#123;“$where”:”this.x+this.y==10″&#125;)</span><br><span class="line">&gt; db.foo.find(&#123;“$where”:”function()&#123;return this.x+this.y==10;&#125;”&#125;)</span><br></pre></td></tr></table></figure>
<p>tips：不是非常必要时，一定要避免使用”$where”查询，因为效率太低，相当的。文档在MongoDB中是以BSON格式保存的，在$where查询时，每个文档都要从BSON转换为javascript对象然后再通过”$where”中的表达式来运行。有时可以将常规查询作为前置过滤，再使用”$where”查询对结果进行调优</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-_id%E5%92%8CObjectId/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-_id%E5%92%8CObjectId/" class="post-title-link" itemprop="url">MongoDB-`_id`和ObjectId</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-31 13:21:11" itemprop="dateCreated datePublished" datetime="2016-12-31T13:21:11+08:00">2016-12-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>转自：<a target="_blank" rel="noopener" href="http://book.51cto.com/art/201112/307016.htm">http://book.51cto.com/art/201112/307016.htm</a></p>
<h2 id="id和ObjectId"><a href="#id和ObjectId" class="headerlink" title="_id和ObjectId"></a><code>_id和ObjectId</code></h2><p>MongoDB 中存储的文档必须有一个”<code>_id</code>“ 键。这个键的值可以是任何类型的，默认是个ObjectId 对象。在一个集合里面，每个文档都有唯一的”<code>_id</code>“ 值，来确保集合里面每个文档都能被唯一标识。如果有两个集合的话，两个集合可以都有一个值为123 的”<code>_id</code>“ 键，但是每个集合里面只能有一个”<code>_id</code>“ 是123 的文档。</p>
<h3 id="ObjectId"><a href="#ObjectId" class="headerlink" title="ObjectId"></a>ObjectId</h3><p>ObjectId 是”<code>_id</code>“ 的默认类型。它设计成轻量型的，不同的机器都能用全局唯一的同种方法方便地生成它。这是MongoDB 采用ObjectId，而不是其他比较常规的做法（比如自动增加的主键）的主要原因，因为在多个服务器上同步自动增加主键值既费力还费时。MongoDB 从一开始就设计用来作为分布式数据库，处理多个节点是一个核心要求。后面会看到ObjectId 类型在分片环境中要容易生成得多。</p>
<p>ObjectId 使用12 字节的存储空间，每个字节两位十六进制数字，是一个24 位的字符串。由于看起来很长，不少人会觉得难以处理。但关键是要知道这个长长的ObjectId 是实际存储数据的两倍长。</p>
<p>如果快速连续创建多个ObjectId，会发现每次只有最后几位数字有变化。另外，中间的几位数字也会变化（要是在创建的过程中停顿几秒钟）。这是ObjectId 的创建方式导致的。12 字节按照如下方式生成：</p>
<p><img src="/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-_id%E5%92%8CObjectId/1.png" alt="1"></p>
<h4 id="ObjectId生成规则"><a href="#ObjectId生成规则" class="headerlink" title="ObjectId生成规则"></a>ObjectId生成规则</h4><h5 id="4字节：UNIX时间戳"><a href="#4字节：UNIX时间戳" class="headerlink" title="4字节：UNIX时间戳"></a>4字节：UNIX时间戳</h5><p>前4 个字节是从标准纪元开始的时间戳，单位为秒。这会带来一些有用的属性。时间戳，与随后的 5 个字节组合起来，提供了秒级别的唯一性。</p>
<p>由于时间戳在前，这意味着ObjectId 大致会按照插入的顺序排列。这对于某些方面很有用，如将其作为索引提高效率，但是这个是没有保证的，仅仅是“大致”。</p>
<p>这4 个字节也隐含了文档创建的时间。绝大多数驱动都会公开一个方法从ObjectId 获取这个信息。</p>
<p>因为使用的是当前时间，很多用户担心要对服务器进行时间同步。其实没有这个必要，因为时间戳的实际值并不重要，只要其总是不停增加就好了（每秒一次）。</p>
<h5 id="3字节：表示运行MongoDB的机器"><a href="#3字节：表示运行MongoDB的机器" class="headerlink" title="3字节：表示运行MongoDB的机器"></a>3字节：表示运行MongoDB的机器</h5><p>接下来的3 字节是所在主机的唯一标识符。通常是机器主机名的散列值。这样就可以确保不同主机生成不同的ObjectId，不产生冲突。</p>
<h5 id="2字节：表示生成此-id的进程"><a href="#2字节：表示生成此-id的进程" class="headerlink" title="2字节：表示生成此_id的进程"></a>2字节：表示生成此_id的进程</h5><p>为了确保在同一台机器上并发的多个进程产生的ObjectId 是唯一的，接下来的两字节来自产生ObjectId 的进程标识符（PID）。</p>
<h5 id="3字节：由一个随机数开始的计数器生成的值"><a href="#3字节：由一个随机数开始的计数器生成的值" class="headerlink" title="3字节：由一个随机数开始的计数器生成的值"></a>3字节：由一个随机数开始的计数器生成的值</h5><p>前9 字节保证了同一秒钟不同机器不同进程产生的ObjectId 是唯一的。后3 字节就是一个自动增加的计数器，确保相同进程同一秒产生的ObjectId 也是不一样的。同一秒钟最多允许每个进程拥有2563（16 777 216）个不同的ObjectId。</p>
<h3 id="自动生成-id"><a href="#自动生成-id" class="headerlink" title="自动生成_id"></a>自动生成_id</h3><p>前面讲到，如果插入文档的时候没有”<code>_id</code>“ 键，系统会自动帮你创建一个。可以由MongoDB 服务器来做这件事情，但通常会在客户端由驱动程序完成。理由如下。</p>
<p>虽然ObjectId 设计成轻量型的，易于生成，但是毕竟生成的时候还是产生开销。在客户端生成体现了MongoDB 的设计理念：能从服务器端转移到驱动程序来做的事，就尽量转移。这种理念背后的原因是，即便是像MongoDB 这样的可扩展数据库，扩展应用层也要比扩展数据库层容易得多。将事务交由客户端来处理，就减轻了数据库扩展的负担。</p>
<p>在客户端生成ObjectId，驱动程序能够提供更加丰富的API。例如，驱动程序可以有自己的insert 方法，可以返回生成的ObjectId，也可以直接将其插入文档。如果驱动程序允许服务器生成ObjectId，那么将需要单独的查询，以确定插入的文档中的”<code>_id</code>“ 值。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/" class="post-title-link" itemprop="url">MongoDB-常用命令-增删改查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-31 10:21:13" itemprop="dateCreated datePublished" datetime="2016-12-31T10:21:13+08:00">2016-12-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><p><code>db.collection.insert()</code></p>
<p><img src="/2016/12/31/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/%E6%8F%92%E5%85%A5.png" alt="插入"></p>
<p>存储在MongoDB集合中的每个文档（document）都有一个默认的主键_id，这个主键名称是固定的，它可以是MongoDB支持的任何数据类型，默认是ObjectId</p>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p><code>db.collection.find()</code></p>
<h3 id="数组查询"><a href="#数组查询" class="headerlink" title="数组查询"></a>数组查询</h3><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$all</td>
<td align="center">通过多个元素来匹配数组。</td>
</tr>
<tr>
<td align="center">$size</td>
<td align="center">查询特定长度的数组。</td>
</tr>
<tr>
<td align="center">$slice</td>
<td align="center">返回数组的一个子集合。</td>
</tr>
</tbody></table>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p><code>db.food.find()</code></p>
<p>数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;001&quot;, &quot;fruits&quot; : [ &quot;苹果&quot;, &quot;香蕉&quot;, &quot;橘子&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;002&quot;, &quot;fruits&quot; : [ &quot;苹果&quot;, &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;003&quot;, &quot;fruits&quot; : [ &quot;圣女果&quot;, &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="all"><a href="#all" class="headerlink" title="$all"></a>$all</h5><p>查询水果列表中既有苹果又有桃子的食品：<code>db.food.find(&#123;&quot;fruits&quot;:&#123;&quot;$all&quot;:[&quot;苹果&quot;,&quot;桃子&quot;]&#125;&#125;) --这是AND的关系</code></p>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;002&quot;, &quot;fruits&quot; : [ &quot;苹果&quot;, &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<p>查询水果列表中下标为1的元素是梨子的食品：<code>db.food.find(&#123;&quot;fruits.1&quot;:&quot;梨子&quot;&#125;)</code></p>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;002&quot;, &quot;fruits&quot; : [ &quot;苹果&quot;, &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;003&quot;, &quot;fruits&quot; : [ &quot;圣女果&quot;, &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="size"><a href="#size" class="headerlink" title="$size"></a>$size</h5><p>数组包含3个元素的文档：<code>db.food.find(&#123;&quot;fruits&quot;:&#123;&quot;$size&quot;:3&#125;&#125;)</code></p>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;001&quot;, &quot;fruits&quot; : [ &quot;苹果&quot;, &quot;香蕉&quot;, &quot;橘子&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="slice"><a href="#slice" class="headerlink" title="$slice"></a>$slice</h5><p>返回lists后3个元素：<code>db.test.find(&#123;&#125;,&#123;&quot;lists&quot;:&#123;&quot;$slice&quot;:-3&#125;&#125;)</code></p>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : &quot;001&quot;, &quot;fruits&quot; : [ &quot;苹果&quot;, &quot;香蕉&quot;, &quot;橘子&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;002&quot;, &quot;fruits&quot; : [ &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;003&quot;, &quot;fruits&quot; : [ &quot;梨子&quot;, &quot;橘子&quot;, &quot;桃子&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p><code>db.collection.update(&lt;query&gt;, &lt;update&gt;, upsert:&lt;boolean&gt;, multi:&lt;boolean&gt;) </code></p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">类型</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">query</td>
<td align="center">document</td>
<td align="center">要修改哪些的查询条件，类似于SQL 的 where</td>
</tr>
<tr>
<td align="center">update</td>
<td align="center">document</td>
<td align="center">要修改的字段对应的值</td>
</tr>
<tr>
<td align="center">upsert</td>
<td align="center">boolean</td>
<td align="center">可选的，默认值是false。如果根据查询条件没找到对应的文档，如果设置为true，相当于执行insert，如果设置为false,不做任何的操作。</td>
</tr>
<tr>
<td align="center">multi</td>
<td align="center">boolean</td>
<td align="center">可选的，默认值是false。如果根据查询条件找到对应的多条记录是，如果设置为false时，只修改第一条，如果设置为true，全部更新。</td>
</tr>
</tbody></table>
<h3 id="对单个字段进行修改"><a href="#对单个字段进行修改" class="headerlink" title="对单个字段进行修改"></a>对单个字段进行修改</h3><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$inc</td>
<td align="center">根据要添加的值递增该字段的值。</td>
</tr>
<tr>
<td align="center">$mul</td>
<td align="center">将该字段的值乘以指定的值</td>
</tr>
<tr>
<td align="center">$rename</td>
<td align="center">重命名字段</td>
</tr>
<tr>
<td align="center">$setOnInsert</td>
<td align="center">操作时,操作给相应的字段赋值</td>
</tr>
<tr>
<td align="center">$set</td>
<td align="center">用来指定一个键的值，如果不存在则创建它</td>
</tr>
<tr>
<td align="center">$unset</td>
<td align="center">用来指定一个键的值，如果不存在不创建创建它</td>
</tr>
<tr>
<td align="center">$min</td>
<td align="center">只有当指定的值小于现有字段值时才更新该字段。</td>
</tr>
<tr>
<td align="center">$max</td>
<td align="center">只有当指定的值大于现有字段值时才更新该字段。</td>
</tr>
<tr>
<td align="center">$currentDate</td>
<td align="center">设置当前日期字段的值，或者作为一个日期或时间戳。</td>
</tr>
</tbody></table>
<h3 id="对数组进行修改"><a href="#对数组进行修改" class="headerlink" title="对数组进行修改"></a>对数组进行修改</h3><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$</td>
<td align="center">作为一个占位符的更新与查询条件在一个更新的第一要素</td>
</tr>
<tr>
<td align="center">$addToSet</td>
<td align="center">将元素添加到数组中，仅当它们在集合中不存在</td>
</tr>
<tr>
<td align="center">$pop</td>
<td align="center">删除数组的第一个或最后一个项</td>
</tr>
<tr>
<td align="center">$pullAll</td>
<td align="center">从数组中移除所有匹配值</td>
</tr>
<tr>
<td align="center">$pull</td>
<td align="center">移除匹配指定查询的所有数组元素</td>
</tr>
<tr>
<td align="center">$pushAll</td>
<td align="center">将所有值添加到数组中（Deprecated since version 2.4: Use the $push operator with $each instead.）</td>
</tr>
<tr>
<td align="center">$push</td>
<td align="center">将值添加到数组中，如果有的数组存在则向数组末尾添加该值，如果数组不存在则创建该数组并保存该值</td>
</tr>
</tbody></table>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p><code>db.collection.remove()</code></p>
<p>删除orders集合的数据，集合还存在，索引都还存在</p>
<h3 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h3><p><code>db.collection.drop()</code></p>
<p>集合、索引都不存在了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/30/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E6%95%B0%E7%BB%84-elemMatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/30/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E6%95%B0%E7%BB%84-elemMatch/" class="post-title-link" itemprop="url">MongoDB-elemMatch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-30 17:45:41" itemprop="dateCreated datePublished" datetime="2016-12-30T17:45:41+08:00">2016-12-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>$elemMatch</code>是用来匹配数组内的元素的。</p>
<p>与<code>.</code>容易产生混淆。</p>
<h3 id="elemMatch与-对比"><a href="#elemMatch与-对比" class="headerlink" title="$elemMatch与.对比"></a><code>$elemMatch</code>与<code>.</code>对比</h3><h4 id="初始化源数据"><a href="#初始化源数据" class="headerlink" title="初始化源数据"></a>初始化源数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.em.insert(&#123;&quot;arr&quot;:[&#123;&quot;e1&quot;:&quot;a&quot;,&quot;e2&quot;:11&#125;,&#123;&quot;e1&quot;:&quot;b&quot;,&quot;e2&quot;:12&#125;,&#123;&quot;e1&quot;:&quot;c&quot;,&quot;e2&quot;:13&#125;,&#123;&quot;e1&quot;:&quot;d&quot;,&quot;e2&quot;:14&#125;]&#125;)</span><br><span class="line">db.em.insert(&#123;&quot;arr&quot;:[&#123;&quot;e1&quot;:&quot;a&quot;,&quot;e2&quot;:21&#125;,&#123;&quot;e1&quot;:&quot;b&quot;,&quot;e2&quot;:22&#125;,&#123;&quot;e1&quot;:&quot;c&quot;,&quot;e2&quot;:23&#125;,&#123;&quot;e1&quot;:&quot;d&quot;,&quot;e2&quot;:24&#125;]&#125;)</span><br><span class="line">db.em.insert(&#123;&quot;arr&quot;:[&#123;&quot;e1&quot;:&quot;a&quot;,&quot;e2&quot;:31&#125;,&#123;&quot;e1&quot;:&quot;b&quot;,&quot;e2&quot;:32&#125;,&#123;&quot;e1&quot;:&quot;c&quot;,&quot;e2</span><br><span class="line">&quot;:33&#125;,&#123;&quot;e1&quot;:&quot;d&quot;,&quot;e2&quot;:34&#125;]&#125;)</span><br><span class="line">db.em.insert(&#123;&quot;arr&quot;:[&#123;&quot;e1&quot;:&quot;a&quot;,&quot;e2&quot;:41&#125;,&#123;&quot;e1&quot;:&quot;b&quot;,&quot;e2&quot;:42&#125;,&#123;&quot;e1&quot;:&quot;c&quot;,&quot;e2&quot;:43&#125;,&#123;&quot;e1&quot;:&quot;d&quot;,&quot;e2&quot;:44&#125;]&#125;)</span><br><span class="line">db.em.insert(&#123;&quot;arr&quot;:[&#123;&quot;e1&quot;:&quot;a&quot;,&quot;e2&quot;:51&#125;,&#123;&quot;e1&quot;:&quot;b&quot;,&quot;e2&quot;:52&#125;,&#123;&quot;e1&quot;:&quot;c&quot;,&quot;e2&quot;:53&#125;,&#123;&quot;e1&quot;:&quot;d&quot;,&quot;e2&quot;:54&#125;]&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="用-查询"><a href="#用-查询" class="headerlink" title="用.查询"></a>用<code>.</code>查询</h4><p><code>db.em.find(&#123;&quot;arr&quot;:&#123;$elemMatch: &#123;&quot;e1&quot;:&quot;a&quot;,&quot;e2&quot;:32&#125;&#125;&#125;)</code></p>
<p>无结果集</p>
<h4 id="用-elemMatch查询"><a href="#用-elemMatch查询" class="headerlink" title="用$elemMatch查询"></a>用<code>$elemMatch</code>查询</h4><p><code>db.em.find(&#123;&quot;arr.e1&quot;:&quot;a&quot;,&quot;arr.e2&quot;:32&#125;)</code></p>
<p>查询结果如下：<br><img src="/2016/12/30/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/MongoDB-%E6%95%B0%E7%BB%84-elemMatch/1.png" alt="1"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li><code>$elemMatch</code>：数组内单个元素匹配则符合</li>
<li><code>.</code>：数组内多个元素能分别匹配上条件即符合</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL-%E5%85%83%E6%95%B0%E6%8D%AE-information_schema%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL-%E5%85%83%E6%95%B0%E6%8D%AE-information_schema%E5%BA%93/" class="post-title-link" itemprop="url">MySQL-元数据-information_schema库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-29 14:34:27" itemprop="dateCreated datePublished" datetime="2016-12-29T14:34:27+08:00">2016-12-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在mysql中有一个information_schema数据库，这个数据库中装的是mysql的元数据，包括数据库信息、数据库中表的信息等。所以要想查询数据库占用磁盘的空间大小可以通过对information_schema数据库进行操作。</p>
<p>information_schema中的表主要有：</p>
<ul>
<li>schemata表：这个表里面主要是存储在mysql中的所有的数据库的信息</li>
<li>tables表：这个表里存储了所有数据库中的表的信息，包括每个表有多少个列等信息。</li>
<li>columns表：这个表存储了所有表中的表字段信息。</li>
<li>statistics表：存储了表中索引的信息。</li>
<li>user_privileges表：存储了用户的权限信息。</li>
<li>schema_privileges表：存储了数据库权限。</li>
<li>table_privileges表：存储了表的权限。</li>
<li>column_privileges表：存储了列的权限信息。</li>
<li>character_sets表：存储了mysql可以用的字符集的信息。</li>
<li>collations表：提供各个字符集的对照信息。</li>
<li>collation_character_set_applicability表：相当于collations表和character_sets表的前两个字段的一个对比，记录了字符集之间的对照信息。</li>
<li>table_constraints表：这个表主要是用于记录表的描述存在约束的表和约束类型。</li>
<li>key_column_usage表：记录具有约束的列。</li>
<li>routines表：记录了存储过程和函数的信息，不包含自定义的过程或函数信息。</li>
<li>views表：记录了视图信息，需要有show view权限。</li>
<li>triggers表：存储了触发器的信息，需要有super权限。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL-%E5%85%83%E6%95%B0%E6%8D%AE-%E6%9F%A5%E8%AF%A2%E8%A1%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL-%E5%85%83%E6%95%B0%E6%8D%AE-%E6%9F%A5%E8%AF%A2%E8%A1%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/" class="post-title-link" itemprop="url">MySQL-元数据（information_schema库）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-29 14:34:27" itemprop="dateCreated datePublished" datetime="2016-12-29T14:34:27+08:00">2016-12-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use information_schema;</span><br><span class="line"></span><br><span class="line">select concat(round(data_length/1024/1024,2),&#x27;MB&#x27;) as data_length_MB,</span><br><span class="line">concat(round(index_length/1024/1024,2),&#x27;MB&#x27;) as index_length_MB</span><br><span class="line">from tables where</span><br><span class="line">table_schema=&#x27;&lt;数据库名&gt;&#x27;</span><br><span class="line">and table_name = &#x27;&lt;表名&gt;&#x27;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wetts.github.io/2016/12/27/%E9%98%85%E8%AF%BB/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E9%AB%98%E6%80%A7%E8%83%BDMySQL%EF%BC%88%E7%AC%AC%E4%B8%89%E7%89%88%EF%BC%89/6.4.3-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zhang Wetts">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wetts's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/27/%E9%98%85%E8%AF%BB/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E9%AB%98%E6%80%A7%E8%83%BDMySQL%EF%BC%88%E7%AC%AC%E4%B8%89%E7%89%88%EF%BC%89/6.4.3-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">高性能MySQL-6.4.3-查询优化处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-27 22:34:13" itemprop="dateCreated datePublished" datetime="2016-12-27T22:34:13+08:00">2016-12-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>查询的生命周期的下一步是将一个SQL转换成一个执行计划，MySQL再按照这个执行计划和存储引擎进行交互。这包括多个子阶段：解析SQL、预处理、优化SQL执行计划。这个过程中任何错误（例如语法错误）都可能终止查询。</p>
<h3 id="语法解析器和预处理"><a href="#语法解析器和预处理" class="headerlink" title="语法解析器和预处理"></a>语法解析器和预处理</h3><p>首先，MySQL通过关键字将SQL语句进行解析，并生成一颗对应的“解析树”。MySQL解析器将使用MySQL语法规则验证和解析查询。例如，它将验证是否使用错误的关键字，或者使用关键字的顺序是否正确等，再或者它还会验证引号是否能前后正确匹配。</p>
<p>预处理器则根据一些MySQL规则进一步检查解析树是否合法，例如，这里将检查数据表和数据列是否存在，还会解析名字和别名，看看它们是否有歧义。</p>
<p>下一步预处理器会验证权限。这通常很快，除非服务器上有非常多的权限配置。</p>
<h3 id="查询优化器"><a href="#查询优化器" class="headerlink" title="查询优化器"></a>查询优化器</h3><p>现在语法树被认为是合法的了，并且由优化器将其转化成执行计划。一条查询可以有很多种执行方式，最后都返回相同的结果。优化器的作用就是找到这其中最好的执行计划。</p>
<p>MySQL使用基于成本的优化器，它将尝试预测一个查询使用某种执行计划时的成本，并选择其中成本最小的一个。最初，成本的最小单位是随机读取一个4K数据页的成本，后来（成本计算公式）变得更加复杂，并且引入了一些“因子”来估算某些操作的代价，如当执行一次WHERE条件比较的成本。可以通过查询当前会话的Last_query_cost的值来得知MySQL计算的当前查询的成本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT SQL_NO_CACHE COUNT(*) FROM sakila.file_actor;</span><br><span class="line"></span><br><span class="line">SHOW STATUS LIKE &#x27;Last_query_cost&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="有很多原因会导致MySQL优化器选择错误的执行计划"><a href="#有很多原因会导致MySQL优化器选择错误的执行计划" class="headerlink" title="有很多原因会导致MySQL优化器选择错误的执行计划"></a>有很多原因会导致MySQL优化器选择错误的执行计划</h4><ul>
<li>统计信息不准确。MySQL以来存储引擎提供的统计信息来评估成本，但是有的存储引擎提供的信息是准确的，有的偏差可能非常大。例如，InnoDB因为其MVCC的架构，并不能维护一个数据表的行数的精确统计信息。</li>
<li>执行计划中的成本估算不等同于实际执行的成本。所以即使统计信息精准，优化器给出的执行计划也可能不是最优的。例如有时候某个执行计划虽然需要读取更多的页面，但是它的成本却更小。因为如果这些页面都是顺序读或者这些页面都已经在内存中的话，那么它的访问成本将很小。MySQL层面并不知道哪些页面在内存中，哪些在磁盘上，所以查询实际执行过程中到底需要多少次物理I/O是无法得知的。</li>
<li>MySQL的最优可能和你想的最优不一样。你可能希望执行时间尽可能的短，但是MySQL只是基于其成本模型选择最优的执行计划，而有些时候这并不是最快的执行方式。所以这里我们看到根据执行成本来选择执行计划并不是完美的模型。</li>
<li>MySQL从不考虑其他并发执行的查询，这可能会影响到当前查询的速度。</li>
<li>MySQL也并不会任何时候都是基于成本的优化。有时也会基于一些固定的规则，例如，如果存在全文搜索的MATCH()子句，则在存在全文所以的时候就使用全文索引。即使有时候使用别的索引和WHERE条件可以远比这种方式要快，MySQL也仍然会使用对应的全文索引。</li>
<li>MySQL不会考虑不受其控制的操作的成本，例如执行存储过程或者用户自定义函数的成本。</li>
<li>后面我们还会看到，优化器有时候无法去估算所有可能的执行计划，所以它可能错过实际上最优的执行计划。</li>
</ul>
<h4 id="静态优化和动态优化"><a href="#静态优化和动态优化" class="headerlink" title="静态优化和动态优化"></a>静态优化和动态优化</h4><p>MySQL的查询优化器是一个非常复杂的部件，它使用了很多优化策略来生成一个最优的执行计划。优化策略可以简单地分为两种，一种是静态优化，一种是动态优化。</p>
<ul>
<li>静态优化可以直接对解析树进行分析，并完成优化。例如，优化器可以通过一些简单的代数变换将WHERE条件转换成另一种等价形式。静态优化不依赖于特别的数值，如WHERE条件中带入的一些常数等。静态优化在第一次完成后就一直有效，即使使用不同的参数重复执行查询也不会发生变化。可以认为这是一种“编译时优化”。</li>
<li>动态优化则和查询的上下文有关，也可能和很多其他因素相关，例如WHERE条件中的取值、索引中条目对应的数据行数等。这需要在每次查询的时候都重新评估，可以认为这是“运行时优化”。</li>
</ul>
<p>在执行语句和存储过程的时候，动态优化和静态优化的区别非常重要。MySQL对查询的静态优化只需要一次，但对查询的动态优化则在每次执行时都需要重新评估。有时候甚至在查询的执行过程中也会重新优化（例如，在关联操作中，范围检查在执行计划会针对每一行重新评估索引）。</p>
<h4 id="下面是一些MySQL能够处理的优化类型"><a href="#下面是一些MySQL能够处理的优化类型" class="headerlink" title="下面是一些MySQL能够处理的优化类型"></a>下面是一些MySQL能够处理的优化类型</h4><h5 id="重新定义关联表的顺序"><a href="#重新定义关联表的顺序" class="headerlink" title="重新定义关联表的顺序"></a>重新定义关联表的顺序</h5><p>数据表的关联并不总是按照在查询中指定的顺序进行。决定关联的顺序是优化器很重要的一部分功能。</p>
<h5 id="将外连接转化成内连接"><a href="#将外连接转化成内连接" class="headerlink" title="将外连接转化成内连接"></a>将外连接转化成内连接</h5><p>并不是所有的OUTER JOIN语句都必须以外连接的方式执行。诸多因素，例如WHERE条件、库表结构都可能会让外连接等价于一个内连接。MySQL能够识别这点并重写查询，让其可以调整关联顺序。</p>
<h5 id="使用等价变换规则"><a href="#使用等价变换规则" class="headerlink" title="使用等价变换规则"></a>使用等价变换规则</h5><p>MySQL可以使用一些等价变换来简化并规范化表达式。它可以合并和减少一些比较，还可以移除一些恒成立和一些恒不成立的判断。例如：<code>(5=5 AND a&gt;5)</code>将被改写为<code>a&gt;5</code>。类似的，如果有<code>(a&lt;b AND b=c) AND a=5</code>则会改写为<code>b&gt;5 AND b=c AND a=5</code>。</p>
<h5 id="优化COUNT-、MIN-和MAX"><a href="#优化COUNT-、MIN-和MAX" class="headerlink" title="优化COUNT()、MIN()和MAX()"></a>优化COUNT()、MIN()和MAX()</h5><p>索引和列是否可为空通常可以帮助MySQL优化这类表达式。例如，要找到某一列的最小值，只需要查询对应B-Tree索引最左端的记录，MySQL可以直接获取索引的第一行记录。在优化器生成执行计划的时候就可以利用这一点，在B-Tree索引中，优化器会将这个表达式作为一个常数对待。类似的，如果要查找一个最大值，也只需读取B-Tree索引的最后一条记录。如果MySQL使用了这种类型的优化，那么EXPLAIN中就可以看到“Select tables optimized away”。从字面意思可以看出，它表示优化器已经从执行计划中移除了该表，并以一个常数取而代之。</p>
<p>类似的，没有任何WHERE条件的<code>COUNT(*)</code>查询通常也可以使用存储引擎提供的一些优化（例如，MyISAM维护了一个变量来存放数据表的行数）。</p>
<h5 id="预估并转化为常数表达式"><a href="#预估并转化为常数表达式" class="headerlink" title="预估并转化为常数表达式"></a>预估并转化为常数表达式</h5><p>当MySQL检测到一个表达式可以转化为常数的时候，就会一直把该表达式作为常数进行优化处理。例如，一个用户自定义变量在查询中没有发生变化时就可以转换为一个常数。</p>
<p>在优化阶段，有时候甚至一个查询也能转化为一个常数。一个例子是在索引列上执行MIN()函数。甚至是主键或者唯一键查找语句也可以转换为常数表达式。如果WHERE子句中使用了该类索引的常数条件，MySQL可以在查询开始阶段就先查找到这些值，这样优化器就能够直到并转换为常数表达式。</p>
<h5 id="覆盖索引扫描"><a href="#覆盖索引扫描" class="headerlink" title="覆盖索引扫描"></a>覆盖索引扫描</h5><p>当索引中的列包含所有查询中需要使用的列的时候，MySQL就可以使用索引返回需要的数据，而无须查询对应的数据行。</p>
<h5 id="子查询优化"><a href="#子查询优化" class="headerlink" title="子查询优化"></a>子查询优化</h5><p>MySQL在某些情况下可以将子查询转换一种效率更高的形式，从而减少多个查询多次对数据进行访问。</p>
<h5 id="提前终止查询"><a href="#提前终止查询" class="headerlink" title="提前终止查询"></a>提前终止查询</h5><p>在发现已经满足查询需求的时候，MySQL总是能够立刻终止查询。一个典型的例子就是当使用了LIMIT子句的时候。除此之外，MySQL还有几类情况也会提前终止查询，例如发现了一个不成立的条件，这时MySQL可以立刻返回一个空结果。除此之外，MySQL在执行过程中，如果发现某些特殊的条件，则会提前终止查询</p>
<h5 id="等值传播"><a href="#等值传播" class="headerlink" title="等值传播"></a>等值传播</h5><p>如果两个列的值通过等式关联，那么MySQL能够把其中一个列的WHERE条件传递到另一列上。</p>
<h5 id="列表IN-的比较"><a href="#列表IN-的比较" class="headerlink" title="列表IN()的比较"></a>列表IN()的比较</h5><p>在很多数据库系统中，IN()完全等同于多个OR条件的子句，因为这两者是完全等价的。在MySQL中这点是不成立的，MySQL将IN()列表中的数据先进行排序，然后通过二分查找的方式来确定列表中的值是否满足条件，这是一个O(log n)复杂度的操作，等价地转换成OR查询的复杂度为O(n)，对于IN()列表中有大量取值的时候，MySQL的处理速度将会更快。</p>
<h3 id="数据和所有的统计信息"><a href="#数据和所有的统计信息" class="headerlink" title="数据和所有的统计信息"></a>数据和所有的统计信息</h3><p>在服务器层有查询优化器，却没有保存数据和索引的统计信息。统计信息由存储引擎实现，不同的存储引擎可能会存储不同的统计信息（也可以按照不同的格式存储统计信息）。某些引擎，例如Archive引擎，则根本就没有存储任何统计信息！</p>
<p>因为服务器层没有任何统计信息，所以MySQL查询优化器在生成查询的执行计划时，需要向存储引擎获取相应的统计信息。存储引擎则提供给优化器对应的统计信息，包括：每个表或者索引有多少个页面、每个表的每个索引的基数是多少、数据行和索引长度、索引的分布信息等。优化器根据这些信息来选择一个最优的执行计划。</p>
<h3 id="MySQL如何执行关联查询"><a href="#MySQL如何执行关联查询" class="headerlink" title="MySQL如何执行关联查询"></a>MySQL如何执行关联查询</h3><p>MySQL中“关联”一词所包含的意义比一般意义上理解的要更广泛。总的来说，MySQL认为任何一个查询都是一次“关联”——并不仅仅是一个查询需要到两个表匹配才叫关联，所以在MySQL中，每一个查询，每一个片段（包括子查询、甚至基于单表的SELECT）都可能是关联。</p>
<p>当前MySQL关联执行的策略很简单：MySQL对任何关联都执行嵌套循环关联操作，即MySQL先在一个表中循环取出单条数据，然后在嵌套循环到下一个表中寻找匹配的行，依次下去，直到找到所有表总匹配的行为止。然后根据各个表匹配的行，返回查询中需要的各个列。MySQL会尝试在最后一个关联表中找到所有匹配的行，如果最后一个关联表无法找到更多的行以后，MySQL返回到上一层次关联表，看是否能够找到更多的匹配记录，一次类推迭代执行。</p>
<h3 id="执行计划"><a href="#执行计划" class="headerlink" title="执行计划"></a>执行计划</h3><p>和很多其他关系数据库不同，MySQL并不会生成查询字节码来执行查询。MySQL生成查询的一颗指令树，然后通过存储引擎执行完成这颗指令树并返回结果。最终的执行计划包含了重构查询的全部信息。</p>
<p>MySQL执行计划是一颗左侧深度优先的树。</p>
<h3 id="关联查询优化器"><a href="#关联查询优化器" class="headerlink" title="关联查询优化器"></a>关联查询优化器</h3><p>MySQL优化器最重要的一部分就是关联查询优化，它决定了都个表关联时的顺序。</p>
<h3 id="排序优化"><a href="#排序优化" class="headerlink" title="排序优化"></a>排序优化</h3><p>无论如何排序都是一个成本很高的操作，所以从性能角度考虑，应尽可能避免排序或者尽可能避免对大量数据进行排序。</p>
<p>当不能使用索引生成排序结果的时候，MySQL需要自己进行排序，如果数据量小则在内存中进行，如果数据量大则需要使用磁盘，不过MySQL将这个过程统一称为文件排序（filesort），即使完全是内存排序不需要任何磁盘文件时也是如此。</p>
<p>如果需要排序的数据量小于“排序缓冲区”，MySQL使用内存进行“快速排序”操作。如果内存不够排序，那么MySQL会先将数据分块，对每个独立的块使用“快速排序”进行排序，并将各个块的排序结果存放到磁盘上，然后将各个排好序的块进行合并（merge），最后返回排序结果。</p>
<p>MySQL有如下两种排序法：</p>
<h4 id="两次传输排序（旧版本使用）"><a href="#两次传输排序（旧版本使用）" class="headerlink" title="两次传输排序（旧版本使用）"></a>两次传输排序（旧版本使用）</h4><p>读取行指针和需要排序的字段，对其进行排序，然后再根据排序结果读取所需要的数据行。</p>
<p>这需要进行两次数据传输，即需要从数据表中读取两次数据，第二次读取数据的时候，因为是读取排序列进行排序后的所有记录，这会产生大量的随机I/O，所以两次数据传输的成本非常高。当使用的是MyISAM表的时候，成本可能会更高，因为MyISAM使用系统调用进行数据的读取（MyISAM非常依赖操作系统对数据的缓存）。不过这样做的优点是，在排序的时候存储尽可能少的数据，这就让“排序缓冲区”中可能容纳尽可能多的行数进行排序。</p>
<h4 id="单次传输排序（新版本使用）"><a href="#单次传输排序（新版本使用）" class="headerlink" title="单次传输排序（新版本使用）"></a>单次传输排序（新版本使用）</h4><p>先读取查询所需要的所有列，然后在根据给定列进行排序，最后直接返回排序结果。这个算法只在MySQL 4.1和后续更新的版本才引入。因为不再需要从数据表中读取两次数据，对于I/O密集型的应用，这样做的效率高了很多。另外，相比两次传输排序，这个算法只需要一次顺序I/O读取所有的数据，而无须任何的随机I/O。缺点是，如果需要返回的列非常多、非常大，会额外占用大量的空间，而这些列对排序操作本身来说是没有任何作用的。因为单条排序记录很大，所以可能会有更多的排序块需要合并。</p>
<p>很难说哪个算法效率更高，两种算法都有各自最好和最糟的场景。当查询需要所有列的总长度不超过参数max_length_for_sort_data时，MySQL使用“单次传输排序”，可以通过调整这个参数来影响MySQL排序算法的选择。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/24/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><span class="page-number current">25</span><a class="page-number" href="/page/26/">26</a><span class="space">&hellip;</span><a class="page-number" href="/page/70/">70</a><a class="extend next" rel="next" href="/page/26/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhang Wetts"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Zhang Wetts</p>
  <div class="site-description" itemprop="description">Stay Hungry, Stay Foolish. <br><br><p style="font-size:8px;">[build by hexo/next/gitalk/hexo-generator-search/LaTeX]</p></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">694</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">343</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wetts" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wetts" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhang.wetts@163.com" title="E-Mail → mailto:zhang.wetts@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Wetts</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
